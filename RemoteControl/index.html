<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¿œç¨‹æ§åˆ¶</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #1a1a2e;
            color: #eee;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* çŠ¶æ€æ  */
        #status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            z-index: 100;
            font-size: 14px;
        }
        
        #status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #f44;
        }
        
        #status-dot.connected {
            background: #4f4;
        }
        
        #fps-info {
            color: #888;
        }
        
        /* å·¥å…·æ  */
        #toolbar {
            display: flex;
            gap: 5px;
        }
        
        .tool-btn {
            background: #333;
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .tool-btn:active {
            background: #555;
        }
        
        .tool-btn.active {
            background: #4a9eff;
        }
        
        /* å±å¹•å®¹å™¨ */
        #screen-container {
            position: fixed;
            top: 40px;
            left: 0;
            right: 0;
            bottom: 50px;
            overflow: auto;
            background: #000;
        }
        
        #screen {
            display: block;
            transform-origin: 0 0;
        }
        
        /* åº•éƒ¨æ§åˆ¶æ  */
        #control-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: 100;
        }
        
        /* æ¨ªå±ä¼˜åŒ– */
        @media (orientation: landscape) {
            #status-bar {
                height: 32px;
                font-size: 12px;
            }
            #screen-container {
                top: 32px;
                bottom: 40px;
            }
            #control-bar {
                height: 40px;
            }
            .ctrl-btn {
                padding: 6px 16px;
                font-size: 12px;
            }
            #keyboard-area {
                bottom: 45px;
            }
            #keyboard-input {
                padding: 8px;
                font-size: 14px;
            }
            #btn-send {
                padding: 8px 16px;
                font-size: 12px;
            }
        }
        
        /* å…¨å±æ¨¡å¼ */
        body.fullscreen #status-bar,
        body.fullscreen #control-bar {
            display: none;
        }
        body.fullscreen #screen-container {
            top: 0;
            bottom: 0;
        }
        
        .ctrl-btn {
            background: #333;
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            min-width: 60px;
        }
        
        .ctrl-btn:active {
            background: #555;
        }
        
        /* é”®ç›˜è¾“å…¥åŒºåŸŸ */
        #keyboard-area {
            position: fixed;
            bottom: 55px;
            left: 10px;
            right: 10px;
            display: none;
            gap: 8px;
            z-index: 100;
        }
        
        #keyboard-area.show {
            display: flex;
        }
        
        #keyboard-input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            background: #2a2a3e;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
        }
        
        #btn-send {
            padding: 10px 20px;
            font-size: 14px;
            background: #4a9eff;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
        }
        
        #btn-send:active {
            background: #3080dd;
        }
        
        /* è¿æ¥ç•Œé¢ */
        #connect-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        
        #connect-overlay.hidden {
            display: none;
        }
        
        #connect-overlay h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        #connect-overlay p {
            color: #888;
            margin-bottom: 30px;
        }
        
        #connect-btn {
            background: #4a9eff;
            border: none;
            color: #fff;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
        }
        
        #connect-btn:disabled {
            background: #555;
        }
        
        /* è§¦æ‘¸æŒ‡ç¤ºå™¨ */
        .touch-indicator {
            position: fixed;
            width: 40px;
            height: 40px;
            border: 2px solid rgba(74, 158, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            animation: touch-pulse 0.3s ease-out;
        }
        
        @keyframes touch-pulse {
            from {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            to {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- è¿æ¥ç•Œé¢ -->
    <div id="connect-overlay">
        <h1>ğŸ“± è¿œç¨‹æ§åˆ¶</h1>
        <p>ç‚¹å‡»è¿æ¥åˆ°ç”µè„‘</p>
        <button id="connect-btn">è¿æ¥</button>
    </div>
    
    <!-- çŠ¶æ€æ  -->
    <div id="status-bar">
        <div id="status">
            <div id="status-dot"></div>
            <span id="status-text">æœªè¿æ¥</span>
            <span id="fps-info"></span>
        </div>
        <div id="toolbar">
            <button class="tool-btn" id="btn-fit">é€‚åº”</button>
            <button class="tool-btn" id="btn-1x">1:1</button>
            <button class="tool-btn" id="btn-keyboard">é”®ç›˜</button>
        </div>
    </div>
    
    <!-- å±å¹•æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="screen-container">
        <canvas id="screen"></canvas>
    </div>
    
    <!-- é”®ç›˜è¾“å…¥ -->
    <div id="keyboard-area">
        <input type="text" id="keyboard-input" placeholder="è¾“å…¥æ–‡å­—...">
        <button id="btn-send">å‘é€</button>
    </div>
    
    <!-- åº•éƒ¨æ§åˆ¶æ  -->
    <div id="control-bar">
        <button class="ctrl-btn" id="btn-esc">ESC</button>
        <button class="ctrl-btn" id="btn-tab">Tab</button>
        <button class="ctrl-btn" id="btn-enter">Enter</button>
        <button class="ctrl-btn" id="btn-back">â†</button>
    </div>
    
    <script>
        // ============================================================
        // å…¨å±€çŠ¶æ€
        // ============================================================
        
        const state = {
            ws: null,
            connected: false,
            screenWidth: 0,
            screenHeight: 0,
            scale: 1,
            fitMode: 'fit', // 'fit' or '1x'
            lastFrameTime: 0,
            frameCount: 0,
            fps: 0,
        };
        
        // DOMå…ƒç´ 
        const $overlay = document.getElementById('connect-overlay');
        const $connectBtn = document.getElementById('connect-btn');
        const $statusDot = document.getElementById('status-dot');
        const $statusText = document.getElementById('status-text');
        const $fpsInfo = document.getElementById('fps-info');
        const $container = document.getElementById('screen-container');
        const $canvas = document.getElementById('screen');
        const $keyboardInput = document.getElementById('keyboard-input');
        const ctx = $canvas.getContext('2d');
        
        // ============================================================
        // WebSocketè¿æ¥
        // ============================================================
        
        function connect() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${location.host}/ws`;
            
            $connectBtn.disabled = true;
            $connectBtn.textContent = 'è¿æ¥ä¸­...';
            
            try {
                state.ws = new WebSocket(wsUrl);
                state.ws.binaryType = 'arraybuffer';
                
                state.ws.onopen = () => {
                    console.log('WebSocketå·²è¿æ¥');
                };
                
                state.ws.onmessage = handleMessage;
                
                state.ws.onclose = () => {
                    console.log('WebSocketå·²æ–­å¼€');
                    setConnected(false);
                };
                
                state.ws.onerror = (err) => {
                    console.error('WebSocketé”™è¯¯:', err);
                    setConnected(false);
                };
                
            } catch (err) {
                console.error('è¿æ¥å¤±è´¥:', err);
                setConnected(false);
            }
        }
        
        function setConnected(connected) {
            state.connected = connected;
            
            if (connected) {
                $overlay.classList.add('hidden');
                $statusDot.classList.add('connected');
                $statusText.textContent = 'å·²è¿æ¥';
            } else {
                $overlay.classList.remove('hidden');
                $statusDot.classList.remove('connected');
                $statusText.textContent = 'æœªè¿æ¥';
                $connectBtn.disabled = false;
                $connectBtn.textContent = 'é‡æ–°è¿æ¥';
            }
        }
        
        // ============================================================
        // æ¶ˆæ¯å¤„ç†
        // ============================================================
        
        function handleMessage(event) {
            // äºŒè¿›åˆ¶æ•°æ® = å±å¹•å¸§
            if (event.data instanceof ArrayBuffer) {
                const blob = new Blob([event.data], { type: 'image/jpeg' });
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                    URL.revokeObjectURL(img.src);
                    updateFps();
                };
                img.src = URL.createObjectURL(blob);
                return;
            }
            
            // JSONæ¶ˆæ¯
            try {
                const data = JSON.parse(event.data);
                
                if (data.type === 'info') {
                    state.screenWidth = data.width;
                    state.screenHeight = data.height;
                    $canvas.width = data.width;
                    $canvas.height = data.height;
                    updateScale();
                    setConnected(true);
                }
            } catch (err) {
                console.error('è§£ææ¶ˆæ¯å¤±è´¥:', err);
            }
        }
        
        function updateFps() {
            state.frameCount++;
            const now = Date.now();
            if (now - state.lastFrameTime >= 1000) {
                state.fps = state.frameCount;
                state.frameCount = 0;
                state.lastFrameTime = now;
                $fpsInfo.textContent = `${state.fps} FPS`;
            }
        }
        
        // ============================================================
        // å‘é€äº‹ä»¶
        // ============================================================
        
        function send(data) {
            if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                state.ws.send(JSON.stringify(data));
            }
        }
        
        function sendMouseEvent(type, x, y, extra = {}) {
            send({
                category: 'mouse',
                type: type,
                x: x,
                y: y,
                ...extra
            });
        }
        
        function sendKeyEvent(key, extra = {}) {
            send({
                category: 'keyboard',
                type: 'keydown',
                key: key,
                ...extra
            });
        }
        
        // ============================================================
        // è§¦æ‘¸/é¼ æ ‡äº‹ä»¶å¤„ç†
        // ============================================================
        
        function getCanvasCoords(clientX, clientY) {
            const rect = $canvas.getBoundingClientRect();
            const x = (clientX - rect.left) / state.scale;
            const y = (clientY - rect.top) / state.scale;
            return { x, y };
        }
        
        let touchState = {
            startX: 0,
            startY: 0,
            startTime: 0,
            lastTapTime: 0,
            moved: false,
            scrollMode: false,
        };
        
        $canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const coords = getCanvasCoords(touch.clientX, touch.clientY);
            
            touchState.startX = coords.x;
            touchState.startY = coords.y;
            touchState.startTime = Date.now();
            touchState.moved = false;
            touchState.scrollMode = e.touches.length >= 2;
            
            showTouchIndicator(touch.clientX, touch.clientY);
        }, { passive: false });
        
        $canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const coords = getCanvasCoords(touch.clientX, touch.clientY);
            
            const dx = coords.x - touchState.startX;
            const dy = coords.y - touchState.startY;
            
            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                touchState.moved = true;
            }
            
            // åŒæŒ‡æ»šåŠ¨
            if (touchState.scrollMode || e.touches.length >= 2) {
                const scrollDelta = Math.round(dy / 10);
                if (scrollDelta !== 0) {
                    sendMouseEvent('scroll', coords.x, coords.y, { delta: -scrollDelta });
                    touchState.startY = coords.y;
                }
                return;
            }
            
            // å•æŒ‡ç§»åŠ¨é¼ æ ‡
            sendMouseEvent('move', coords.x, coords.y);
        }, { passive: false });
        
        $canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            
            const duration = Date.now() - touchState.startTime;
            const now = Date.now();
            
            // æ£€æµ‹åŒå‡»
            if (!touchState.moved && duration < 200) {
                if (now - touchState.lastTapTime < 300) {
                    // åŒå‡»
                    sendMouseEvent('doubleclick', touchState.startX, touchState.startY);
                    touchState.lastTapTime = 0;
                } else {
                    // å•å‡»
                    sendMouseEvent('click', touchState.startX, touchState.startY);
                    touchState.lastTapTime = now;
                }
            }
        }, { passive: false });
        
        // é•¿æŒ‰å³é”®
        let longPressTimer = null;
        
        $canvas.addEventListener('touchstart', (e) => {
            longPressTimer = setTimeout(() => {
                const touch = e.touches[0];
                const coords = getCanvasCoords(touch.clientX, touch.clientY);
                sendMouseEvent('click', coords.x, coords.y, { button: 'right' });
            }, 500);
        });
        
        $canvas.addEventListener('touchend', () => {
            clearTimeout(longPressTimer);
        });
        
        $canvas.addEventListener('touchmove', () => {
            clearTimeout(longPressTimer);
        });
        
        // è§¦æ‘¸æŒ‡ç¤ºå™¨
        function showTouchIndicator(x, y) {
            const indicator = document.createElement('div');
            indicator.className = 'touch-indicator';
            indicator.style.left = x + 'px';
            indicator.style.top = y + 'px';
            document.body.appendChild(indicator);
            setTimeout(() => indicator.remove(), 300);
        }
        
        // ============================================================
        // ç¼©æ”¾æ§åˆ¶
        // ============================================================
        
        function updateScale() {
            const containerWidth = $container.clientWidth;
            const containerHeight = $container.clientHeight;
            
            if (state.fitMode === 'fit') {
                const scaleX = containerWidth / state.screenWidth;
                const scaleY = containerHeight / state.screenHeight;
                state.scale = Math.min(scaleX, scaleY, 1);
            } else {
                state.scale = 1;
            }
            
            $canvas.style.transform = `scale(${state.scale})`;
        }
        
        document.getElementById('btn-fit').addEventListener('click', () => {
            state.fitMode = 'fit';
            updateScale();
        });
        
        document.getElementById('btn-1x').addEventListener('click', () => {
            state.fitMode = '1x';
            updateScale();
        });
        
        window.addEventListener('resize', updateScale);
        
        // ============================================================
        // é”®ç›˜æ§åˆ¶
        // ============================================================
        
        const $keyboardArea = document.getElementById('keyboard-area');
        
        document.getElementById('btn-keyboard').addEventListener('click', () => {
            $keyboardArea.classList.toggle('show');
            if ($keyboardArea.classList.contains('show')) {
                $keyboardInput.focus();
            }
        });
        
        // å‘é€æŒ‰é’®
        document.getElementById('btn-send').addEventListener('click', () => {
            const text = $keyboardInput.value;
            if (text) {
                sendText(text);
                $keyboardInput.value = '';
            }
            $keyboardInput.focus();
        });
        
        // å‘é€æ•´æ®µæ–‡æœ¬
        function sendText(text) {
            if (text) {
                send({
                    category: 'keyboard',
                    type: 'text',
                    text: text
                });
            }
        }
        
        $keyboardInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const text = $keyboardInput.value;
                if (text) {
                    sendText(text);  // å‘é€æ•´æ®µæ–‡æœ¬
                }
                sendKeyEvent('Enter');
                $keyboardInput.value = '';
                e.preventDefault();
            }
        });
        
        // åŒå‡»å…¨å±åˆ‡æ¢
        let lastTapForFullscreen = 0;
        document.getElementById('status-bar').addEventListener('dblclick', () => {
            document.body.classList.toggle('fullscreen');
        });
        
        // åº•éƒ¨æ§åˆ¶æŒ‰é’®
        document.getElementById('btn-esc').addEventListener('click', () => {
            sendKeyEvent('Escape');
        });
        
        document.getElementById('btn-tab').addEventListener('click', () => {
            sendKeyEvent('Tab');
        });
        
        document.getElementById('btn-enter').addEventListener('click', () => {
            sendKeyEvent('Enter');
        });
        
        document.getElementById('btn-back').addEventListener('click', () => {
            sendKeyEvent('Backspace');
        });
        
        // ============================================================
        // åˆå§‹åŒ–
        // ============================================================
        
        $connectBtn.addEventListener('click', connect);
        
        // è‡ªåŠ¨è¿æ¥
        // connect();
    </script>
</body>
</html>
